<!DOCTYPE html>
<html lang="es">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href='https://fonts.googleapis.com/css?family=Chivo' rel='stylesheet'>
    <link rel="stylesheet" href="{% static 'css/espejo.css' %}">
</head>

<body>
    <div class="mensaje_bot">
        <h1>Hola!</h1>
    </div>
    <div id="mensajeUsuarioContainer"></div>
    <div class="wrap">
        <button id="empezar" class="button">Empezar</button>
        <button id="terminar" class="button">Terminar</button>
    </div>
    <script>
        const startButton = document.getElementById('empezar');
        const stopButton = document.getElementById('terminar');

        let audioChunks = [];
        let mediaRecorder;

        startButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then((stream) => {
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        enviarAudioAlServidor(audioBlob);
                    };

                    startButton.disabled = true;
                    stopButton.disabled = false;
                    audioChunks = [];
                    mediaRecorder.start();
                })
                .catch((error) => {
                    console.error('Error al obtener acceso al micrÃ³fono:', error);
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
            startButton.disabled = false;
            stopButton.disabled = true;
        }

        function enviarAudioAlServidor(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob);

            fetch('/transcribir_audio/', {
                    method: 'POST',
                    body: formData
                })
                .then((response) => response.json())
                .then((data) => {
                    console.log('Respuesta del servidor:', data);
                    const mensajeUsuarioContainer = document.getElementById('mensajeUsuarioContainer');
                    const mensajeUsuario = document.createElement('div');
                    mensajeUsuario.classList.add('mensaje_usuario');
                    mensajeUsuario.innerHTML = data.texto;
                    mensajeUsuarioContainer.appendChild(mensajeUsuario);
                    mensajeUsuario.scrollIntoView();
                })
                .catch((error) => {
                    console.error('Error al enviar audio al servidor:', error);
                });
        }
    </script>
</body>

</html>